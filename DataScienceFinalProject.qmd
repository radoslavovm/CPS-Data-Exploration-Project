---
title: "Data Science I Final Project"
author: "Ayaka, Martina, and Rosie"
format: pdf
---

## Set-Up
```{r setup}
library(tidyr)
library(tidycensus)
library(dplyr)
library(purrr)
library(here)
library(tidyverse)
library(psych)
library(ggplot2)
library(cluster)
library(GGally)
library(factoextra)
library(ggcorrplot)
library(maps)

```

## Data Construction
```{r api key}
# Access to ACS datasets using tidycensus
census_api_key("4b11e9f5d9ac286e1a22800c7e56fc771229ec6a", install = TRUE)
```

### ACS Tables:
- B02001: Race
    - Includes total population and counts for major racial groups 
      (White alone, Black alone, Asian alone, Two or more races)

- B15003: Educational Attainment (Population 25 Years and Older)
    - Includes high school diploma, bachelor's degree, and doctorate 
      attainment counts

- B25003: Housing Tenure
    - Includes counts of owner-occupied vs renter-occupied housing units

- B07007: Geographic Mobility by Citizenship Status
    - Includes total population for mobility, native population, and 
      foreign-born population

- B16001: Language Spoken at Home (Population Age 5+)
    - Includes total population age 5+ and count of individuals who speak 
      only English at home

- B17001: Poverty Status in the Past 12 Months
    - Includes total poverty universe and individuals below the poverty level

- B08006: Means of Transportation to Work
    - Includes total workers and counts of individuals using public 
      transportation to commute

- B08303: Travel Time to Work
    - Includes total workers and those with long commute times 
      (90+ minutes)

- B09002: Family Type and Subfamilies
    - Includes total family population and married-couple families

- B23025: Employment Status
    - Includes total civilian population age 16+ and unemployed individuals

### Pulling Data and Variables
```{r Generate a list}
# Creating list 
d <- c()
for (i in 1:49) {
  if (i < 10) {
    r <- paste("B01001_00", i, sep = "")
  }
  else {r <- paste("B01001_0", i, sep = "") }
  
  d <- c(d, r)
}
```

```{r Select Variables}
# Variable for data
variables <- 
  c(
    # Race
    'B02001_001', # Total Population
    'B02001_002', # White Alone
    'B02001_003', # Black or African American Alone
    'B02001_005', # Asian Alone
    'B02001_009', # Two or more races
    
    # Educational Attainment
    'B15003_001', # Total Education Population
    'B15003_017', # High School Diploma
    'B15003_022', # Bachelor's Degree
    'B15003_025', # Doctorate Degree
    
    # Housing Status
    'B25003_001', # Total Housing Units
    'B25003_002', # Owner Occupied
    'B25003_003', # Renter Occupied
    
    # Geographic Mobility by Citizenship
    'B07007_001', # Total Population for Mobility
    'B07007_002', # Native Population
    'B07007_003', # Foreign Born Population
    
    # Language Spoken at Home
    "B16001_001", # Total population age 5+ 
    "B16001_002", # Speak only English at home
    
    # Poverty Status
    "B17001_001", # Total 
    "B17001_002", # Income in the past 12 months below poverty level
    
    # Transportation to Work
    "B08006_001",  # Total workers
    "B08006_008",  # Public transportation
    
    # Travel time to work
    "B08303_001", # Total workers
    "B08303_013", # Workers with commute time 90 or more minutes
    
    # Family Characteristics
    "B09002_001",  # Total population in families
    "B09002_002",  # In married-couple families
    
    # Employment Status
    "B23025_001", # Total Population 16+
    "B23025_005"  # Unemployed
    )
```

```{r Data Pull}
# Retrieves ACS estimates for all states (1-year ACS, 2024)
state_level <- get_acs(geography = "state", 
                        variables = variables, 
                        year = 2024,
                        survey = "acs1")
```

### Converting State Data
```{r Convert State Data to Wide Format}
# Pivot wide for state data
state_wide <- state_level %>%
  select(GEOID, NAME, variable, estimate) %>%
  pivot_wider(names_from = variable, values_from = estimate)

```

### Converting Race Data
```{r Race Percentages}
# Race Variables
race_vars <- c("B02001_002", "B02001_003", "B02001_005", "B02001_009")

# Race Percentages
race_df <- state_wide %>%
  mutate(total_pop = B02001_001) %>%
  mutate(across(all_of(race_vars),
                ~ .x / total_pop * 100,
                .names = "pct_{.col}"))

```

```{r Race Data Plot}
# Race Data Plot
ggplot(race_df, aes(x = pct_B02001_002, y = pct_B02001_003, label = NAME)) +
  geom_point() +
  ggrepel::geom_text_repel() +
  labs(x = "% White", y = "% Black", 
       title = "Race Composition by State (ACS 2024)") +
  theme_minimal()

```

### Converting Education Data
```{r Education Data}
education_df <- state_wide %>%
  mutate(pct_bachelors_plus = 
           (B15003_022 + B15003_025) / B15003_001 * 100)

```

```{r Top 10 most educated states}
# Top 10
education_df %>%
  arrange(desc(pct_bachelors_plus)) %>%
  slice(1:10)

```

```{r Map of education percentage}
states_map <- map_data("state")

education_plot <- education_df %>%
  mutate(state = tolower(NAME))

merged_map <- states_map %>%
  left_join(education_plot, by = c("region" = "state"))

ggplot(merged_map, aes(long, lat, group = group, fill = pct_bachelors_plus)) +
  geom_polygon(color = "white") +
  coord_map() +
  scale_fill_viridis_c(option = "plasma") +
  labs(title = "Percent with Bachelor's Degree or Higher (ACS 2024)",
       fill = "% BA+") +
  theme_void()


```

```{r Housing tenure: % owner-occupied vs rented}
housing_df <- state_wide %>%
  mutate(
    pct_owner = B25003_002 / B25003_001 * 100,
    pct_renter = B25003_003 / B25003_001 * 100
  )

```

```{r Owner vs Renter}
ggplot(housing_df, aes(x = pct_owner, y = pct_renter, label = NAME)) +
  geom_point() +
  ggrepel::geom_text_repel() +
  labs(x = "% Owner-Occupied", y = "% Renter-Occupied",
       title = "Housing Tenure by State (ACS 2024)") +
  theme_minimal()
```

```{r Geographic mobility: % who lived in same house 1 year ago}
mobility_df <- state_wide %>%
  mutate(
    pct_same_house = B07007_002 / B07007_001 * 100,
    pct_same_county = B07007_003 / B07007_001 * 100
  )
```

```{r Mobility by state}
ggplot(mobility_df, aes(x = pct_same_house, y = pct_same_county, label = NAME)) +
  geom_point() +
  ggrepel::geom_text_repel() +
  labs(x = "% Same House 1 Year Ago", y = "% Same County 1 Year Ago",
       title = "Geographic Mobility (ACS 2024)") +
  theme_minimal()
```

```{r Correlation analysis}
merged <- state_wide %>%
  mutate(
    pct_bachelors_plus = (B15003_022 + B15003_025) / B15003_001 * 100,
    pct_owner = B25003_002 / B25003_001 * 100
  )

ggplot(merged, aes(x = pct_bachelors_plus, y = pct_owner)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(title = "Education vs Homeownership by State",
       x = "% Bachelor's or Higher",
       y = "% Owner Occupied") +
  theme_minimal()

```

```{r Rank states on any metric}
race_df %>%
  select(NAME, pct_B02001_003) %>%
  arrange(desc(pct_B02001_003))

```


# Data

```{r data}
both <- get_acs(geography = "county", 
                state = c("CA", "TX"),
                variables = c("B01001_001", "B07009_013", "B16001_002", "B17001_002", "C22001_002", 
                              "B23008_001", "C24070_002", "B07013_016", "B08006_008", "B25003_002"), 
                year = 2024,
                survey = "acs1") 
pop <- both %>%
  filter(variable == "B01001_001") %>%
  select(GEOID, population = estimate)

both <- both %>%
  left_join(pop, by = "GEOID") %>%
  mutate(normalized_estimate = estimate / population) %>% 
  select(GEOID, NAME, variable, population, normalized_estimate) %>%
  pivot_wider(
    names_from = variable,
    values_from = normalized_estimate
  )


```

# EDA

```{r eda, warning=FALSE}
sum(is.na(both))
both <- na.omit(both)
sum(is.na(both))

# Check for correlation among variables & remove highly correlated variables
GGally::ggcorr(both, size = 2)

# Numeric columns only for analyses
both_num <- both %>%
  dplyr::select(-c(GEOID, NAME))
```

"C22001_002", "B25003_002", "B07009_013", "B23008_001", "population" were highly correlated among the select variables.

# PCA

```{r pca}
# B01001_001 has 0 variance since variables are normalized by population
zero_variance_cols <- names(both_num)[apply(both_num, 2, var, na.rm = TRUE) == 0]
both_num <- both_num[, !(names(both_num) %in% zero_variance_cols)]

pca <- prcomp(both_num, scale. = TRUE)
loadings <- as.data.frame(pca$x)

mapply(shapiro.test, both_num)

mardia(both_num)
KMO(both_num)
cortest.bartlett(both_num)
fa.parallel(both_num, fa = "fa")
```

# Clustering

```{r clustering}

Xsc <- scale(both_num)

set.seed(100)

m <- c( "average", "single", "complete", "ward")
names(m) <- c( "average", "single", "complete", "ward")
ac <- function(x) {
  agnes(Xsc, method = x)$ac
  }
purrr::map_dbl(m, ac)

distance <- dist(Xsc, method = "euclidean")
hc_complete <- hclust(distance, method = 'ward.D2')
plot(hc_complete)

plot <- fviz_dend(hc_complete, k = 2)
plot +
  theme_minimal() +
  labs(title = "Dendrogram based on Hierarchical Clustering")

sub_grp <- cutree(hc_complete, 2)


```