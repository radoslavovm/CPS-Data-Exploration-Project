---
title: "Data Science I Final Project"
author: "Ayaka, Martina, and Rosie"
format: pdf
---

## Set-Up
```{r setup}
# Libraries
library(tidyr)
library(tidycensus)
library(dplyr)
library(purrr)
library(here)
library(tidyverse)
library(psych)
library(ggplot2)
library(cluster)
library(GGally)
library(factoextra)
library(ggcorrplot)
library(maps)
library(gtsummary)
library(gt)
library(clustertend)
library(NbClust)
library(clValid)
library(mclust)
library(sf)
```

## Data Construction
```{r api key}
# Access to ACS datasets using tidycensus
census_api_key("4b11e9f5d9ac286e1a22800c7e56fc771229ec6a", install = TRUE)
```

### ACS Tables:
- B02001: Race
    - Includes total population and counts for major racial groups 
      (White alone, Black alone, Asian alone, Two or more races)

- B15003: Educational Attainment (Population 25 Years and Older)
    - Includes high school diploma, bachelor's degree, and doctorate 
      attainment counts

- B25003: Housing Tenure
    - Includes counts of owner-occupied vs renter-occupied housing units

- B07007: Geographic Mobility by Citizenship Status
    - Includes total population for mobility, native population, and 
      foreign-born population

- B17001: Poverty Status in the Past 12 Months
    - Includes total poverty universe and individuals below the poverty level

- B08006: Means of Transportation to Work
    - Includes total workers and counts of individuals using public 
      transportation to commute

- B08303: Travel Time to Work
    - Includes total workers and those with long commute times 
      (90+ minutes)

- B09002: Family Type and Subfamilies
    - Includes total family population and married-couple families

- B23025: Employment Status
    - Includes total civilian population age 16+ and unemployed individuals
    
- B28002: Presence and Types of Internet Subscriptions in Household
-   Includes total and those with an internet subscription


### Pulling Data and Variables
```{r Select Variables}
# Variable list for ACS pull with explanation of variable
variables <- 
  c(
    # Race
    'B02001_001', # Total Population for Races
    'B02001_002', # White Alone
    'B02001_003', # Black or African American Alone
    'B02001_005', # Asian Alone
    'B02001_009', # Two or more races
    
    # Educational Attainment
    'B15003_001', # Total Education Population
    'B15003_017', # High School Diploma
    'B15003_022', # Bachelor's Degree
    'B15003_025', # Doctorate Degree
    
    # Housing Status
    'B25003_001', # Total Housing Units
    'B25003_002', # Owner Occupied
    'B25003_003', # Renter Occupied
    
    # Geographic Mobility by Citizenship
    'B07007_001', # Total Population for Mobility
    'B07007_002', # Native Population
    'B07007_003', # Foreign Born Population
    
    # Poverty Status
    "B17001_001", # Total 
    "B17001_002", # Income in the past 12 months below poverty level
    
    # Transportation to Work
    "B08006_001",  # Total workers
    "B08006_008",  # Public transportation
    
    # Travel time to work
    "B08303_001", # Total workers
    "B08303_013", # Workers with commute time 90 or more minutes
    
    # Family Characteristics/Structure 
    "B09002_001",  # Total population in families
    "B09002_002",  # In married-couple families
    
    # Employment Status
    "B23025_001", # Total Population 16+
    "B23025_005",  # Unemployed
    
    # Internet 
    "B28002_001", # Total
    "B28002_002" # With Internet Subscription in Household
    )
```

```{r Data Pull}
# Retrieves ACS estimates for counties in TX (2019-2023 5-year ACS)
tx_counties <- get_acs(
  geography = "county", 
  state = "TX", 
  variables = variables, 
  year = 2023,
  survey = "acs5"
)
```
```{r ACS Wide Format}
tx_counties <- tx_counties %>%
  select(GEOID, NAME, variable, estimate) %>%
  pivot_wider(names_from = variable, values_from = estimate)
```


### Converting variables to percentgaes
```{r}
acs_clean <- tx_counties %>%
  mutate(
    # Race
    percent_white = B02001_002 / B02001_001 * 100,
    percent_black = B02001_003 / B02001_001 * 100,
    percent_asian = B02001_005 / B02001_001 * 100,
    percent_two_or_more  = B02001_009 / B02001_001 * 100,
    
    # Education
    percent_hs_diploma = B15003_017 / B15003_001 * 100,
    percent_bachelors = B15003_022 / B15003_001 * 100,
    percent_doctorate = B15003_025 / B15003_001 * 100,
    
    # Housing
    percent_owner_occupied = B25003_002 / B25003_001 * 100,
    percent_renter = B25003_003 / B25003_001 * 100,
    
    # Mobility
    percent_native_us = B07007_002 / B07007_001 * 100,
    percent_foreign_born = B07007_003 / B07007_001 * 100,
    
    # Poverty
    percent_poverty = B17001_002 / B17001_001 * 100,
    
    # Public Transit
    percent_public_transit = B08006_008 / B08006_001 * 100,
    
    # Long Commute to Work
    percent_long_commute = B08303_013 / B08303_001 * 100,
    
    # Family Structure
    percent_married_family = B09002_002 / B09002_001 * 100,
    
    # Unemployment
    percent_unemployed = B23025_005 / B23025_001 * 100,
    
    # Internet
    percent_internet = B28002_002 / B28002_001 * 100
  )

```

### Dataset with Percentage Variables
```{r dataset}
# Dataset With the Percentage Variables/Data
# Rename to cleaner names
data <- acs_clean %>%
  select(NAME, percent_white, percent_black, percent_asian, percent_two_or_more,
         percent_hs_diploma, percent_bachelors, percent_doctorate, percent_owner_occupied, 
         percent_renter, percent_native_us, percent_foreign_born,
         percent_poverty, percent_public_transit, percent_long_commute, 
         percent_married_family, percent_unemployed, percent_internet) %>%
  rename(
    White = percent_white,
    Black = percent_black,
    Asian = percent_asian,
    Two_Races = percent_two_or_more,
    HS_Diploma = percent_hs_diploma,
    Bachelors = percent_bachelors,
    Doctorate = percent_doctorate,
    Owner_Occupied = percent_owner_occupied,
    Renter = percent_renter,
    Native = percent_native_us,
    Foreign_Born = percent_foreign_born,
    Poverty = percent_poverty,
    Public_Transit = percent_public_transit,
    Long_Commute = percent_long_commute,
    Married_Family = percent_married_family,
    Unemployed = percent_unemployed,
    Internet_Subscription = percent_internet
  )
```

## EDA
### Summary Table 
```{r}
# Create summary table with tbl_summary
summary_table <- data %>%
  select(-NAME) %>%
  tbl_summary(
    statistic = all_continuous() ~ "{mean} ({sd})",
    digits = all_continuous() ~ 2, # 2 decimal places
    label = list(
      White ~ "White (%)",
      Black ~ "Black (%)",
      Asian ~ "Asian (%)",
      Two_Races ~ "Two or More Races (%)",
      HS_Diploma ~ "High School Diploma (%)",
      Bachelors ~ "Bachelor’s Degree (%)",
      Doctorate ~ "Doctorate Degree (%)",
      Owner_Occupied ~ "Owner-Occupied Housing (%)",
      Renter ~ "Renter-Occupied Housing (%)",
      Native ~ "Native Population (%)",
      Foreign_Born ~ "Foreign-Born Population (%)",
      Poverty ~ "Below Poverty Line (%)",
      Public_Transit ~ "Public Transit Use (%)",
      Long_Commute ~ "Long Commute (90+ min) (%)",
      Married_Family ~ "Married-Couple Family (%)",
      Unemployed ~ "Unemployment Rate (%)",
      Internet_Subscription ~ "Home Internet Subscription (%)")
    ) %>% 
  modify_caption(
    "Table 1: Socioeconomic Indicators at County Level (Mean and SD; Variables as Percentages)")

# Output
summary_table
```

### Scatterplot of Education vs. Poverty
```{r}
ggplot(data, aes(x = Bachelors, y = Poverty)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(title = "Poverty vs. Bachelor's Degree Attainment Across Texas Counties",
    x = "Bachelor’s Degree (%)",
    y = "Poverty (%)")
```


### Unemployment Histogram
```{r}
ggplot(data, aes(Unemployed)) +
  geom_histogram(bins = 15, fill = "steelblue", col = "black") +
  labs(
    title = "Distribution of Unemployment Rates Across Texas Counties",
    x = "Unemployment (%)",
    y = "Number of Counties"
  )
```
## Maps for all Variables 
```{r}
# Set-Up
# Extract Shape File
tx_shapes <- st_read("tl_rd22_us_county.shp")

# Read Texas Only
tx_shapes <- tx_shapes %>% 
  filter(STATEFP == "48")

# Join to acs_clean
map_data <- tx_shapes %>%
  left_join(acs_clean, by = "GEOID")
```
### Map
```{r Map Set-Up}
county_map <- map_data("county") %>%
  filter(region == "texas")

education_plot <- data %>%
  mutate(
    county = tolower(NAME),
    county = gsub(",.*", "", county), # remove everything after a comma
    county = gsub(" county$", "", county), # remove " county"
    county = trimws(county)
  )

merged_map <- county_map %>%
  left_join(education_plot, by = c("subregion" = "county"))
```

```{r Map for Poverty}
# Map for Poverty
ggplot(merged_map, aes(long, lat, group = group, fill = Poverty)) +
  geom_polygon(color = "white") +
  coord_map() +
  scale_fill_viridis_c(option = "plasma") +
  labs(
    title = "Poverty Rates Across Texas Counties",
    fill = "% Poverty"
  ) +
  theme_void()
```

```{r Map for Bachelor's Degree}
# Map for Bachelor's Degree
ggplot(merged_map, aes(long, lat, group = group, fill = Bachelors)) +
  geom_polygon(color = "white") +
  coord_map() +
  scale_fill_viridis_c(option = "plasma") +
  labs(
    title = "Bachelor's Degree Attainment Across Texas Counties",
    fill = "% BA"
  ) +
  theme_void()
```

```{r Map for Unemployment}
# Map for Unemployment 
ggplot(merged_map, aes(long, lat, group = group, fill = Unemployed)) +
  geom_polygon(color = "white") +
  coord_map() +
  scale_fill_viridis_c(option = "plasma") +
  labs(
    title = "Unemployment Rates Across Texas Counties",
    fill = "% Unemployed"
  ) +
  theme_void()
```

```{r Foreign-Born Population Map}
# Map for Foreign-Born Population
ggplot(merged_map, aes(long, lat, group = group, fill = Foreign_Born)) +
  geom_polygon(color = "white") +
  coord_map() +
  scale_fill_viridis_c(option = "plasma") +
  labs(
    title = "Foreign-Born Population Across Texas Counties",
    fill = "% Foreign Born"
  ) +
  theme_void()
```

```{r Native-Born Population Map}
# Map for Native-Born Population
ggplot(merged_map, aes(long, lat, group = group, fill = Native)) +
  geom_polygon(color = "white") +
  coord_map() +
  scale_fill_viridis_c(option = "plasma") +
  labs(
    title = "Native-Born Population Across Texas Counties",
    fill = "% Native"
  ) +
  theme_void()
```

```{r Internet Subscription Map}
# Map for Internet Subscription
ggplot(merged_map, aes(long, lat, group = group, fill = Internet_Subscription)) +
  geom_polygon(color = "white") +
  coord_map() +
  scale_fill_viridis_c(option = "plasma") +
  labs(
    title = "Home Internet Subscription Across Texas Counties",
    fill = "% Internet"
  ) +
  theme_void()
```

```{r Long Commute to Work Map}
# Map for Long Commute
ggplot(merged_map, aes(long, lat, group = group, fill = Long_Commute)) +
  geom_polygon(color = "white") +
  coord_map() +
  scale_fill_viridis_c(option = "plasma") +
  labs(
    title = "Share of Workers With Long Commutes (90+ min) in Texas Counties",
    fill = "% Long Commute"
  ) +
  theme_void()
```

```{r Owner Occupied House Map}
# Owning House Map
ggplot(merged_map, aes(long, lat, group = group, fill = Owner_Occupied)) +
  geom_polygon(color = "white") +
  coord_map() +
  scale_fill_viridis_c(option = "plasma") +
  labs(
    title = "Owner-Occupied Housing Across Texas Counties",
    fill = "% Owner Occupied"
  ) +
  theme_void()
```

```{r Married-Couple Families Map}
# Married-Couple Family Map
ggplot(merged_map, aes(long, lat, group = group, fill = Married_Family)) +
  geom_polygon(color = "white") +
  coord_map() +
  scale_fill_viridis_c(option = "plasma") +
  labs(
    title = "Married-Couple Families Across Texas Counties",
    fill = "% Married Families"
  ) +
  theme_void()
```

## PCA 

### Correlation Heatmap
```{r}
# Correlation Heatmap
ggcorr(data, hjust = .9, size = 2, layout.exp = 2)
```

### NA
```{r}
# Check which have NAs
colSums(is.na(data %>% select(-NAME)))

# Remove NAs for PCA
clean_data <- data %>%
  select(-NAME) %>%
  na.omit() # Removes states with missing values
```

### Run PCA
```{r}
# Run PCA
pca_result <- prcomp(clean_data, center = TRUE, scale. = TRUE)

# PCA Summary
summary(pca_result)
```

### Proportion of Variance and Cummulative Variance 
```{r}
## Compute manually 
explained_variance <- pca_result$sdev^2 / sum(pca_result$sdev^2)

## Use summary output
explained_variance <- summary(pca_result)$importance[2,]

# Proportion of Variance explained (PVE) by each PC
plot(explained_variance, xlab = "Principal Component",
     ylab = "Proportion of Variance Explained", ylim = c(0, 1),
     type = "b")

# Cumulative PVE across all PCs
plot(cumsum(explained_variance), xlab = "Principal Component",
     ylab = "Cumulative Proportion of Variance Explained",
     ylim = c(0, 1), type = "b")
```



### Scree Plot
```{r}
# Scree Plot through Function
fviz_eig(pca_result, addlabels = TRUE)
```

### Biplot
```{r}
# Biplot 
fviz_pca_biplot(pca_result, geom.ind = "point", repel = TRUE)
```
### Loadings and Scores
```{r}
# Extract loadings from the PCA result
loadings <- pca_result$rotation[, 1]

loadings
# Plot
ggplot() +
  geom_bar(
    aes(
      x = reorder(names(loadings), 
                  abs(loadings)),
      y = loadings), stat = "identity") +
  coord_flip() +
  labs(title = paste("Loadings for the first PC"), x = "Variable", y = "Loading")
```

## Clustering
### Read and Visaulize Data
```{r}
# Standardize the dataset (Removing name and scaling)
df <- data %>%
  select(-NAME) %>%
  na.omit() %>%
  scale() 
```

```{r}
# Plot the Dataset (Lab 3)
fviz_pca_ind(
  prcomp(df),
  title = "PCA – Texas County-Level Socioeconomic Data",
  geom = "point",
  ggtheme = theme_classic()
)
```

### Compute the Hopkins statistic
```{r}
# Compute Hopkins statistic (Way from lab would not work)
set.seed(2025)

m <- round(nrow(df) * 0.1)  # 10% of rows
hopkins(df, m = m)

```
### NbClust() for best number of clusters
```{r}
pc <- prcomp(df, scale.=TRUE)
df_pc <- pc$x[, 1:5]  # use enough to explain ~80% variance

nb <- NbClust(df_pc, distance="euclidean", min.nc=2, max.nc=10, method="kmeans")
```
### Performing K-Means Clustering
```{r}
set.seed(2025)

# K-means 
km.res1 <- kmeans(df, 3)
fviz_cluster(list(data = df, cluster = km.res1$cluster), ellipse.type = "norm", geom = "point", stand = FALSE, palette = "jco", ggtheme = theme_classic())
```

### Visaulize Pairwise Distance
```{r}
fviz_dist(dist(df), show_labels = FALSE) +
  labs(title = "Distance Matrix – Texas County Data")
```

### Compare Clustering Methods
```{r}
set.seed(2025)
cl_methods <- c("hierarchical", "kmeans", "pam", "model")

internal_valid <- clValid(df, 
                          nClust = 2:6,
                          clMethods = cl_methods,
                          validation = "internal")

summary(internal_valid)

stab_valid <- clValid(df,
                      nClust = 2:6,
                      clMethods = cl_methods,
                      validation = "stability")

optimalScores(stab_valid)
```

### Hierarchical Clustering 
```{r}
Xsc <- scale(df)

set.seed(100)

m <- c( "average", "single", "complete", "ward")
names(m) <- c( "average", "single", "complete", "ward")
ac <- function(x) {
  agnes(Xsc, method = x)$ac
  }
purrr::map_dbl(m, ac)

distance <- dist(Xsc, method = "euclidean")
hc_complete <- hclust(distance, method = 'ward.D2')
plot(hc_complete)

plot <- fviz_dend(hc_complete, k = 2)
plot +
  theme_minimal() +
  labs(title = "Dendrogram based on Hierarchical Clustering")

sub_grp <- cutree(hc_complete, 2)
```
## Maps for PCA and Clustering 
### PCA Map
```{r}
rows_used_pca <- complete.cases(data %>% select(-NAME))


PC1_full <- rep(NA, nrow(data))
PC2_full <- rep(NA, nrow(data))

PC1_full[rows_used_pca] <- pc_scores$PC1
PC2_full[rows_used_pca] <- pc_scores$PC2

pca_df <- data %>%
  mutate(
    PC1 = PC1_full,
    PC2 = PC2_full,
    county = tolower(NAME),
    county = gsub(",.*", "", county),
    county = gsub(" county$", "", county),
    county = trimws(county)
  )

# Merge with map 
merged_map_pca <- county_map %>%
  left_join(pca_df, by = c("subregion" = "county"))

# PC
ggplot(merged_map_pca, aes(long, lat, group = group, fill = PC1)) +
  geom_polygon(color = "white") +
  coord_map() +
  scale_fill_viridis_c(option = "plasma") +
  labs(
    title = "PCA Component 1 Across Texas Counties",
    fill = "PC1"
  ) +
  theme_void()

ggplot(merged_map_pca, aes(long, lat, group = group, fill = PC2)) +
  geom_polygon(color = "white") +
  coord_map() +
  scale_fill_viridis_c(option = "inferno") +
  labs(
    title = "PCA Component 2 Across Texas Counties",
    fill = "PC2"
  ) +
  theme_void()
```

### Cluster Map
```{r}
# Full-length cluster vector to match data 
cluster_vec <- rep(NA, nrow(data))   

# Insert clusters for rows used in k-means
cluster_vec[rows_used] <- km.res1$cluster

# Attach the clusters and also clean county names
cluster_df <- data %>%
  mutate(
    cluster = cluster_vec,
    county = tolower(NAME),
    county = gsub(",.*", "", county),
    county = gsub(" county$", "", county),
    county = trimws(county)
  )

# Texas counties
county_map <- map_data("county") %>%
  filter(region == "texas")

# Merge cluster info with map
merged_map_cluster <- county_map %>%
  left_join(cluster_df, by = c("subregion" = "county"))

# Plot cluster map
ggplot(merged_map_cluster, aes(long, lat, group = group, fill = factor(cluster))) +
  geom_polygon(color = "white") +
  coord_map() +
  scale_fill_viridis_d(option = "plasma") +
  labs(
    title = "K-Means Clusters of Texas Counties Based on Socioeconomic Indicators",
    fill = "Cluster"
  ) +
  theme_void()
```





