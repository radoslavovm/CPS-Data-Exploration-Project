---
title: "Data Science I Final Project"
author: "Ayaka, Martina, and Rosie"
format: pdf
---

## Set-Up
```{r setup}
# Libraries
library(tidyr)
library(tidycensus)
library(dplyr)
library(purrr)
library(here)
library(tidyverse)
library(psych)
library(ggplot2)
library(cluster)
library(GGally)
library(factoextra)
library(ggcorrplot)
library(maps)
library(gtsummary)
library(gt)
install.packages("clusterend") # Not working
library(clustertend)
install.packages("hopkins")
library(hopkins)
```

## Data Construction
```{r api key}
# Access to ACS datasets using tidycensus
census_api_key("4b11e9f5d9ac286e1a22800c7e56fc771229ec6a", install = TRUE)
```

### ACS Tables:
- B02001: Race
    - Includes total population and counts for major racial groups 
      (White alone, Black alone, Asian alone, Two or more races)

- B15003: Educational Attainment (Population 25 Years and Older)
    - Includes high school diploma, bachelor's degree, and doctorate 
      attainment counts

- B25003: Housing Tenure
    - Includes counts of owner-occupied vs renter-occupied housing units

- B07007: Geographic Mobility by Citizenship Status
    - Includes total population for mobility, native population, and 
      foreign-born population

- B16001: Language Spoken at Home (Population Age 5+)
    - Includes total population age 5+ and count of individuals who speak 
      only English at home

- B17001: Poverty Status in the Past 12 Months
    - Includes total poverty universe and individuals below the poverty level

- B08006: Means of Transportation to Work
    - Includes total workers and counts of individuals using public 
      transportation to commute

- B08303: Travel Time to Work
    - Includes total workers and those with long commute times 
      (90+ minutes)

- B09002: Family Type and Subfamilies
    - Includes total family population and married-couple families

- B23025: Employment Status
    - Includes total civilian population age 16+ and unemployed individuals

### Pulling Data and Variables
```{r Generate a list}
# Creating list 
d <- c()
for (i in 1:49) {
  if (i < 10) {
    r <- paste("B01001_00", i, sep = "")
  }
  else {r <- paste("B01001_0", i, sep = "") }
  
  d <- c(d, r)
}
```

```{r Select Variables}
# Variable list for ACS pull with explanation of variable
variables <- 
  c(
    # Race
    'B02001_001', # Total Population for Races
    'B02001_002', # White Alone
    'B02001_003', # Black or African American Alone
    'B02001_005', # Asian Alone
    'B02001_009', # Two or more races
    
    # Educational Attainment
    'B15003_001', # Total Education Population
    'B15003_017', # High School Diploma
    'B15003_022', # Bachelor's Degree
    'B15003_025', # Doctorate Degree
    
    # Housing Status
    'B25003_001', # Total Housing Units
    'B25003_002', # Owner Occupied
    'B25003_003', # Renter Occupied
    
    # Geographic Mobility by Citizenship
    'B07007_001', # Total Population for Mobility
    'B07007_002', # Native Population
    'B07007_003', # Foreign Born Population
    
    # Language Spoken at Home
    "B16001_001", # Total population age 5+ 
    "B16001_002", # Speak only English at home
    
    # Poverty Status
    "B17001_001", # Total 
    "B17001_002", # Income in the past 12 months below poverty level
    
    # Transportation to Work
    "B08006_001",  # Total workers
    "B08006_008",  # Public transportation
    
    # Travel time to work
    "B08303_001", # Total workers
    "B08303_013", # Workers with commute time 90 or more minutes
    
    # Family Characteristics/Structure 
    "B09002_001",  # Total population in families
    "B09002_002",  # In married-couple families
    
    # Employment Status
    "B23025_001", # Total Population 16+
    "B23025_005"  # Unemployed
    )
```

```{r Data Pull}
# Retrieves ACS estimates for all states (2024 1-year ACS)
state_level <- get_acs(geography = "state", 
                        variables = variables, 
                        year = 2024,
                        survey = "acs1")
```
```{r ACS Wide Format}
state_wide <- state_level %>%
  select(GEOID, NAME, variable, estimate) %>%
  pivot_wider(names_from = variable, values_from = estimate)
```


### Converting variables to percentgaes
```{r}
acs_clean <- state_wide %>%
  mutate(
    # Race
    percent_white = B02001_002 / B02001_001 * 100,
    percent_black = B02001_003 / B02001_001 * 100,
    percent_asian = B02001_005 / B02001_001 * 100,
    percent_two_or_more  = B02001_009 / B02001_001 * 100,
    
    # Education
    percent_hs_diploma = B15003_017 / B15003_001 * 100,
    percent_bachelors = B15003_022 / B15003_001 * 100,
    percent_doctorate = B15003_025 / B15003_001 * 100,
    
    # Housing
    percent_owner_occupied = B25003_002 / B25003_001 * 100,
    percent_renter = B25003_003 / B25003_001 * 100,
    
    # Mobility
    percent_native = B07007_002 / B07007_001 * 100,
    percent_foreign_born = B07007_003 / B07007_001 * 100,
    
    # Language
    percent_english_only = B16001_002 / B16001_001 * 100,
    
    # Poverty
    percent_poverty = B17001_002 / B17001_001 * 100,
    
    # Public Transit
    percent_public_transit = B08006_008 / B08006_001 * 100,
    
    # Long Commute to Work
    percent_long_commute = B08303_013 / B08303_001 * 100,
    
    # Family Structure
    percent_married_family = B09002_002 / B09002_001 * 100,
    
    # Unemployment
    percent_unemployed = B23025_005 / B23025_001 * 100
  )

```

### Dataset with Percentage Variables
```{r dataset}
# Dataset With the Percentage Variables/Data
# Rename to cleaner names
data_EDA <- acs_clean %>%
  select(NAME, percent_white, percent_black, percent_asian, percent_two_or_more,
         percent_hs_diploma, percent_bachelors, percent_doctorate, percent_owner_occupied, 
         percent_renter, percent_native, percent_foreign_born, percent_english_only, 
         percent_poverty, percent_public_transit, percent_long_commute, 
         percent_married_family, percent_unemployed) %>%
  rename(
    White = percent_white,
    Black = percent_black,
    Asian = percent_asian,
    Two_Races = percent_two_or_more,
    HS_Diploma = percent_hs_diploma,
    Bachelors = percent_bachelors,
    Doctorate = percent_doctorate,
    Owner_Occupied = percent_owner_occupied,
    Renter = percent_renter,
    Native = percent_native,
    Foreign_Born = percent_foreign_born,
    English_Only = percent_english_only,
    Poverty = percent_poverty,
    Public_Transit = percent_public_transit,
    Long_Commute = percent_long_commute,
    Married_Family = percent_married_family,
    Unemployed = percent_unemployed
  )
```

## EDA
### Summary Table for all States
```{r}
# Create summary table with tbl_summary
summary_table <- data_EDA %>%
  select(-NAME) %>%
  tbl_summary(
    statistic = all_continuous() ~ "{mean} ({sd})",
    digits = all_continuous() ~ 2, # 2 decimal places
    label = list(
      White ~ "White (%)",
      Black ~ "Black (%)",
      Asian ~ "Asian (%)",
      Two_Races ~ "Two or More Races (%)",
      HS_Diploma ~ "High School Diploma (%)",
      Bachelors ~ "Bachelor’s Degree (%)",
      Doctorate ~ "Doctorate Degree (%)",
      Owner_Occupied ~ "Owner-Occupied Housing (%)",
      Renter ~ "Renter-Occupied Housing (%)",
      Native ~ "Native Population (%)",
      Foreign_Born ~ "Foreign-Born Population (%)",
      English_Only ~ "English Only at Home (%)",
      Poverty ~ "Below Poverty Line (%)",
      Public_Transit ~ "Public Transit Use (%)",
      Long_Commute ~ "Long Commute (90+ min) (%)",
      Married_Family ~ "Married-Couple Family (%)",
      Unemployed ~ "Unemployment Rate (%)")
    ) %>% 
  modify_caption(
    "Table 1: Socioeconomic Indicators at State Level (Mean and SD; Variables as Percentages)")

# Output
summary_table
```

### Comparison Table for Texas and California
```{r}
# Filter data for Texas and California
tx_ca <- data_EDA %>% 
  filter(NAME %in% c("Texas", "California"))

# Pivot to wide so each state has its own column
tx_ca_wide <- tx_ca %>%
  select(NAME, White, Black, Asian, Two_Races, HS_Diploma, Bachelors, Doctorate, 
         Owner_Occupied, Renter, Native, Foreign_Born, English_Only, Poverty, 
         Public_Transit, Long_Commute, Married_Family, Unemployed) %>%
  pivot_longer(-NAME, names_to = "variable", values_to = "value") %>%
  pivot_wider(names_from = NAME, values_from = value)

# Relabel variables for table output
comparison_table <- tx_ca_wide %>%
  mutate(
    variable = case_when(
      variable == "White" ~ "White (%)",
      variable == "Black" ~ "Black (%)",
      variable == "Asian" ~ "Asian (%)",
      variable == "Two_Races" ~ "Two or More Races (%)",
      variable == "HS_Diploma" ~ "High School Diploma (%)",
      variable == "Bachelors" ~ "Bachelor's Degree (%)",
      variable == "Doctorate" ~ "Doctorate Degree (%)",
      variable == "Owner_Occupied" ~ "Owner-Occupied Housing (%)",
      variable == "Renter" ~ "Renter-Occupied Housing (%)",
      variable == "Native" ~ "Native Population (%)",
      variable == "Foreign_Born" ~ "Foreign-Born Population (%)",
      variable == "English_Only" ~ "English Only at Home (%)",
      variable == "Poverty" ~ "Below Poverty Line (%)",
      variable == "Public_Transit" ~ "Public Transit Use (%)",
      variable == "Long_Commute" ~ "Long Commute (90+ min) (%)",
      variable == "Married_Family" ~ "Married-Couple Family (%)",
      variable == "Unemployed" ~ "Unemployment Rate (%)",
      TRUE ~ variable
    )
  ) %>%
  gt() %>% # gt table 
  fmt_number(columns = c(Texas, California), decimals = 2) %>%
  tab_header(title = "Texas vs California: Socioeconomic Characteristics (Percentages)")

# Output
comparison_table

```

### Scatterplot of Education vs. Poverty
```{r}
ggplot(data_EDA, aes(x = Bachelors, y = Poverty)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(title = "Poverty vs. Bachelor's Degree Attainment Across States",
    x = "Bachelor’s Degree (%)",
    y = "Poverty (%)")
```

### Scatterplot of Foreign-Born People vs. English Only at Home
```{r}
ggplot(data_EDA, aes(x = Foreign_Born, y = English_Only)) +
  geom_point() +
  geom_smooth(method = "lm") + 
  labs(title = "Foreign-Born Population vs. English-Only Speakers",
    x = "Foreign-Born (%)",
    y = "English Only at Home (%)")
```

### Unemployment Histogram
```{r}
ggplot(data_EDA, aes(Unemployed)) +
  geom_histogram(bins = 15, fill = "steelblue", col = "black") +
  labs(
    title = "Distribution of Unemployment Rates Across States",
    x = "Unemployment (%)",
    y = "Number of States"
  )
```


## PCA 

### Correlation Heatmap
```{r}
# Correlation Heatmap
ggcorr(data_EDA, hjust = .9, size = 2, layout.exp = 2)
```

### NA
```{r}
# Check which have NAs
colSums(is.na(data_EDA %>% select(-NAME)))

# Remove NAs for PCA
clean_data <- data_EDA %>%
  select(-NAME) %>%
  na.omit() # Removes states with missing values
```
### Run PCA
```{r}
# Run PCA
pca_result <- prcomp(pca_data, center = TRUE, scale. = TRUE)

# PCA Summary
summary(pca_result)
```
### Proportion of Variance and Cummulative Variance 
```{r}
## Compute manually 
explained_variance <- pca_result$sdev^2 / sum(pca_result$sdev^2)

## Use summary output
explained_variance <- summary(pca_result)$importance[2,]

# Proportion of Variance explained (PVE) by each PC
plot(explained_variance, xlab = "Principal Component",
     ylab = "Proportion of Variance Explained", ylim = c(0, 1),
     type = "b")

# Cumulative PVE across all PCs
plot(cumsum(explained_variance), xlab = "Principal Component",
     ylab = "Cumulative Proportion of Variance Explained",
     ylim = c(0, 1), type = "b")
```



### Scree Plot
```{r}
# Scree Plot through Function
fviz_eig(pca_outcome, addlabels = TRUE)
```

### Biplot
```{r}
# Biplot 
fviz_pca_biplot(pca_outcome, geom.ind = "point", repel = TRUE)
```
### Loadings and Scores
```{r}
# Extract loadings from the PCA result
loadings <- pca_result$rotation[, 1]

# Plot
ggplot() +
  geom_bar(
    aes(
      x = reorder(names(loadings), 
                  abs(loadings)),
      y = loadings), stat = "identity") +
  coord_flip() +
  labs(title = paste("Loadings for the first PC"), x = "Variable", y = "Loading")
```

## Clustering
### Read and Visaulize Data
```{r}
# Standardize the dataset (Removing name and scaling)
df <- data_EDA %>%
  select(-NAME) %>%
  na.omit() %>%
  scale() 
```

```{r}
# Plot the Dataset (Lab 3)
fviz_pca_ind(prcomp(df),
             title = "PCA - State-Level ACS Data",
             geom = "point",
             ggtheme = theme_classic())
```

### Compute the Hopkins statistic
```{r}
# Compute Hopkins statistic
set.seed(2025)

# Hopkins test needs a number of samples m, not n=
m <- round(nrow(df) * 0.1)

hopkins(df, m = m)
```
# Ayaka Analysis

```{r clustering}

Xsc <- scale(both_num)

set.seed(100)

m <- c( "average", "single", "complete", "ward")
names(m) <- c( "average", "single", "complete", "ward")
ac <- function(x) {
  agnes(Xsc, method = x)$ac
  }
purrr::map_dbl(m, ac)

distance <- dist(Xsc, method = "euclidean")
hc_complete <- hclust(distance, method = 'ward.D2')
plot(hc_complete)

plot <- fviz_dend(hc_complete, k = 2)
plot +
  theme_minimal() +
  labs(title = "Dendrogram based on Hierarchical Clustering")

sub_grp <- cutree(hc_complete, 2)


```